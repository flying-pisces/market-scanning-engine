{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Market Scanning Engine Portfolio API Schemas",
  "version": "1.0",
  "definitions": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
      "description": "UUID v4 format"
    },
    "score": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100,
      "description": "Score value from 0 to 100"
    },
    "cents": {
      "type": "integer",
      "minimum": 1,
      "description": "Monetary value in cents (to avoid floating point precision issues)"
    },
    "signed_cents": {
      "type": "integer",
      "description": "Monetary value in cents (can be negative for losses)"
    },
    "percentage": {
      "type": "number",
      "minimum": 0,
      "maximum": 100,
      "multipleOf": 0.01,
      "description": "Percentage value with 2 decimal places"
    },
    "signed_percentage": {
      "type": "number",
      "minimum": -100,
      "maximum": 10000,
      "multipleOf": 0.0001,
      "description": "Percentage that can be negative (for losses) or very high (for gains)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp"
    },
    "date": {
      "type": "string",
      "format": "date",
      "description": "ISO 8601 date"
    },
    "email": {
      "type": "string",
      "format": "email",
      "description": "Valid email address"
    }
  },
  
  "UserProfile": {
    "type": "object",
    "title": "User Investment Profile",
    "description": "Complete user profile with risk preferences and constraints",
    "required": [
      "user_id",
      "email",
      "risk_tolerance",
      "max_position_size_pct",
      "max_daily_loss_pct"
    ],
    "properties": {
      "id": {
        "$ref": "#/definitions/uuid",
        "description": "Internal user profile identifier"
      },
      "user_id": {
        "type": "string",
        "maxLength": 255,
        "description": "External authentication system user ID"
      },
      "email": {
        "$ref": "#/definitions/email",
        "description": "User email address"
      },
      "display_name": {
        "type": "string",
        "maxLength": 100,
        "description": "User display name"
      },
      "risk_tolerance": {
        "$ref": "#/definitions/score",
        "description": "Risk tolerance score (0=conservative, 100=aggressive)"
      },
      "max_position_size_pct": {
        "$ref": "#/definitions/percentage",
        "description": "Maximum position size as percentage of portfolio"
      },
      "max_daily_loss_pct": {
        "$ref": "#/definitions/percentage",
        "description": "Maximum acceptable daily loss percentage"
      },
      "min_holding_period_hours": {
        "type": "integer",
        "minimum": 1,
        "default": 1,
        "description": "Minimum holding period in hours"
      },
      "max_holding_period_hours": {
        "type": "integer",
        "minimum": 1,
        "default": 8760,
        "description": "Maximum holding period in hours (default: 1 year)"
      },
      "max_open_positions": {
        "type": "integer",
        "minimum": 1,
        "maximum": 100,
        "default": 10,
        "description": "Maximum number of simultaneous open positions"
      },
      "min_trade_amount_cents": {
        "$ref": "#/definitions/cents",
        "default": 100000,
        "description": "Minimum trade amount in cents ($1000 default)"
      },
      "max_trade_amount_cents": {
        "$ref": "#/definitions/cents",
        "default": 10000000,
        "description": "Maximum trade amount in cents ($100k default)"
      },
      "notification_preferences": {
        "type": "object",
        "description": "User notification preferences",
        "properties": {
          "email_enabled": {
            "type": "boolean",
            "default": true
          },
          "push_enabled": {
            "type": "boolean",
            "default": true
          },
          "sms_enabled": {
            "type": "boolean",
            "default": false
          },
          "min_signal_score": {
            "$ref": "#/definitions/score",
            "default": 60,
            "description": "Minimum signal score for notifications"
          },
          "quiet_hours_start": {
            "type": "string",
            "pattern": "^([01]?[0-9]|2[0-3]):[0-5][0-9]$",
            "description": "Start of quiet hours (HH:MM format)"
          },
          "quiet_hours_end": {
            "type": "string",
            "pattern": "^([01]?[0-9]|2[0-3]):[0-5][0-9]$",
            "description": "End of quiet hours (HH:MM format)"
          }
        },
        "additionalProperties": true
      },
      "is_active": {
        "type": "boolean",
        "default": true,
        "description": "Whether the user profile is active"
      },
      "created_at": {
        "$ref": "#/definitions/timestamp"
      },
      "updated_at": {
        "$ref": "#/definitions/timestamp"
      },
      "asset_preferences": {
        "type": "array",
        "items": {
          "$ref": "#/UserAssetPreference"
        },
        "description": "User's asset class preferences"
      }
    },
    "additionalProperties": false
  },

  "UserAssetPreference": {
    "type": "object",
    "title": "User Asset Class Preference",
    "description": "User's preference and allocation for specific asset classes",
    "required": [
      "user_id",
      "asset_class_id",
      "preference_weight"
    ],
    "properties": {
      "id": {
        "$ref": "#/definitions/uuid"
      },
      "user_id": {
        "$ref": "#/definitions/uuid",
        "description": "User profile identifier"
      },
      "asset_class_id": {
        "type": "integer",
        "minimum": 1,
        "description": "Asset class identifier"
      },
      "preference_weight": {
        "type": "number",
        "minimum": 0,
        "maximum": 1,
        "multipleOf": 0.01,
        "description": "Preference weight (0.0 to 1.0)"
      },
      "is_enabled": {
        "type": "boolean",
        "default": true,
        "description": "Whether this asset class is enabled for the user"
      },
      "created_at": {
        "$ref": "#/definitions/timestamp"
      },
      "updated_at": {
        "$ref": "#/definitions/timestamp"
      }
    },
    "additionalProperties": false
  },

  "TradeExecution": {
    "type": "object",
    "title": "Trade Execution Record",
    "description": "Record of an executed trade with all relevant details",
    "required": [
      "user_id",
      "asset_id",
      "trade_type",
      "quantity",
      "execution_price_cents",
      "position_size_dollars_cents"
    ],
    "properties": {
      "id": {
        "$ref": "#/definitions/uuid"
      },
      "signal_match_id": {
        "$ref": "#/definitions/uuid",
        "description": "Associated signal match that led to this trade"
      },
      "user_id": {
        "$ref": "#/definitions/uuid",
        "description": "User who executed the trade"
      },
      "signal_id": {
        "$ref": "#/definitions/uuid",
        "description": "Signal that triggered this trade"
      },
      "asset_id": {
        "$ref": "#/definitions/uuid",
        "description": "Asset being traded"
      },
      "external_trade_id": {
        "type": "string",
        "maxLength": 100,
        "description": "Broker's trade identifier"
      },
      "order_id": {
        "type": "string",
        "maxLength": 100,
        "description": "Internal order identifier"
      },
      "trade_type": {
        "type": "string",
        "enum": ["BUY", "SELL", "SELL_SHORT", "BUY_TO_COVER"],
        "description": "Type of trade executed"
      },
      "quantity": {
        "type": "integer",
        "not": {
          "const": 0
        },
        "description": "Number of shares/contracts traded (positive or negative)"
      },
      "execution_price_cents": {
        "$ref": "#/definitions/cents",
        "description": "Actual execution price in cents"
      },
      "order_submitted_at": {
        "$ref": "#/definitions/timestamp",
        "description": "When the order was submitted"
      },
      "executed_at": {
        "$ref": "#/definitions/timestamp",
        "description": "When the trade was executed"
      },
      "position_size_dollars_cents": {
        "$ref": "#/definitions/cents",
        "description": "Total position size in cents"
      },
      "position_size_pct_of_portfolio": {
        "$ref": "#/definitions/percentage",
        "description": "Position size as percentage of portfolio"
      },
      "stop_loss_price_cents": {
        "$ref": "#/definitions/cents",
        "description": "Stop loss price in cents"
      },
      "take_profit_price_cents": {
        "$ref": "#/definitions/cents",
        "description": "Take profit price in cents"
      },
      "slippage_bps": {
        "type": "integer",
        "minimum": -10000,
        "maximum": 10000,
        "description": "Slippage in basis points (negative = price improvement)"
      },
      "execution_time_ms": {
        "type": "integer",
        "minimum": 0,
        "description": "Execution time in milliseconds"
      },
      "commission_cents": {
        "type": "integer",
        "minimum": 0,
        "default": 0,
        "description": "Commission paid in cents"
      },
      "sec_fees_cents": {
        "type": "integer",
        "minimum": 0,
        "default": 0,
        "description": "SEC fees in cents"
      },
      "other_fees_cents": {
        "type": "integer",
        "minimum": 0,
        "default": 0,
        "description": "Other fees in cents"
      },
      "status": {
        "type": "string",
        "enum": ["PENDING", "PARTIAL", "EXECUTED", "CANCELLED", "REJECTED"],
        "description": "Trade execution status"
      },
      "broker_name": {
        "type": "string",
        "maxLength": 50,
        "description": "Executing broker name"
      },
      "execution_venue": {
        "type": "string",
        "maxLength": 50,
        "description": "Execution venue identifier"
      },
      "created_at": {
        "$ref": "#/definitions/timestamp"
      },
      "updated_at": {
        "$ref": "#/definitions/timestamp"
      }
    },
    "additionalProperties": false
  },

  "Position": {
    "type": "object",
    "title": "Portfolio Position",
    "description": "Current or historical portfolio position",
    "required": [
      "user_id",
      "asset_id",
      "quantity",
      "average_cost_cents",
      "opened_at"
    ],
    "properties": {
      "id": {
        "$ref": "#/definitions/uuid"
      },
      "user_id": {
        "$ref": "#/definitions/uuid",
        "description": "Position owner"
      },
      "asset_id": {
        "$ref": "#/definitions/uuid",
        "description": "Asset held in position"
      },
      "quantity": {
        "type": "integer",
        "not": {
          "const": 0
        },
        "description": "Position quantity (positive=long, negative=short)"
      },
      "average_cost_cents": {
        "$ref": "#/definitions/cents",
        "description": "Average cost basis in cents per share"
      },
      "current_price_cents": {
        "$ref": "#/definitions/cents",
        "description": "Current market price in cents per share"
      },
      "opened_at": {
        "$ref": "#/definitions/timestamp",
        "description": "When position was opened"
      },
      "last_updated_at": {
        "$ref": "#/definitions/timestamp",
        "description": "Last price/quantity update"
      },
      "closed_at": {
        "$ref": "#/definitions/timestamp",
        "description": "When position was closed (null for open positions)"
      },
      "stop_loss_price_cents": {
        "$ref": "#/definitions/cents",
        "description": "Stop loss price in cents"
      },
      "take_profit_price_cents": {
        "$ref": "#/definitions/cents",
        "description": "Take profit price in cents"
      },
      "trailing_stop_pct": {
        "$ref": "#/definitions/percentage",
        "description": "Trailing stop percentage"
      },
      "realized_pnl_cents": {
        "$ref": "#/definitions/signed_cents",
        "description": "Realized P&L in cents (for closed positions)"
      },
      "originating_signal_ids": {
        "type": "array",
        "items": {
          "$ref": "#/definitions/uuid"
        },
        "description": "Signals that led to this position"
      },
      "status": {
        "type": "string",
        "enum": ["OPEN", "CLOSED", "CLOSING"],
        "description": "Position status"
      },
      "created_at": {
        "$ref": "#/definitions/timestamp"
      },
      "updated_at": {
        "$ref": "#/definitions/timestamp"
      }
    },
    "additionalProperties": false
  },

  "PortfolioSnapshot": {
    "type": "object",
    "title": "Portfolio Performance Snapshot",
    "description": "Daily portfolio performance and risk metrics",
    "required": [
      "user_id",
      "snapshot_date",
      "total_value_cents",
      "cash_balance_cents",
      "equity_value_cents"
    ],
    "properties": {
      "id": {
        "$ref": "#/definitions/uuid"
      },
      "user_id": {
        "$ref": "#/definitions/uuid",
        "description": "Portfolio owner"
      },
      "snapshot_date": {
        "$ref": "#/definitions/date",
        "description": "Date of this snapshot"
      },
      "total_value_cents": {
        "type": "integer",
        "minimum": 0,
        "description": "Total portfolio value in cents"
      },
      "cash_balance_cents": {
        "type": "integer",
        "minimum": 0,
        "description": "Cash balance in cents"
      },
      "equity_value_cents": {
        "type": "integer",
        "minimum": 0,
        "description": "Value of equity positions in cents"
      },
      "unrealized_pnl_cents": {
        "$ref": "#/definitions/signed_cents",
        "default": 0,
        "description": "Unrealized profit/loss in cents"
      },
      "realized_pnl_cents": {
        "$ref": "#/definitions/signed_cents",
        "default": 0,
        "description": "Realized profit/loss in cents"
      },
      "number_of_positions": {
        "type": "integer",
        "minimum": 0,
        "default": 0,
        "description": "Number of open positions"
      },
      "largest_position_pct": {
        "$ref": "#/definitions/percentage",
        "description": "Largest position as percentage of portfolio"
      },
      "portfolio_beta": {
        "type": "number",
        "minimum": -5,
        "maximum": 5,
        "multipleOf": 0.0001,
        "description": "Portfolio beta coefficient"
      },
      "portfolio_var_1d_pct": {
        "type": "number",
        "minimum": 0,
        "maximum": 100,
        "multipleOf": 0.001,
        "description": "1-day portfolio Value at Risk"
      },
      "overall_risk_score": {
        "$ref": "#/definitions/score",
        "description": "Overall portfolio risk score"
      },
      "concentration_risk_score": {
        "$ref": "#/definitions/score",
        "description": "Portfolio concentration risk score"
      },
      "liquidity_risk_score": {
        "$ref": "#/definitions/score",
        "description": "Portfolio liquidity risk score"
      },
      "daily_return_pct": {
        "$ref": "#/definitions/signed_percentage",
        "description": "Daily return percentage"
      },
      "mtd_return_pct": {
        "$ref": "#/definitions/signed_percentage",
        "description": "Month-to-date return percentage"
      },
      "ytd_return_pct": {
        "$ref": "#/definitions/signed_percentage",
        "description": "Year-to-date return percentage"
      },
      "total_return_pct": {
        "$ref": "#/definitions/signed_percentage",
        "description": "Total return percentage since inception"
      },
      "peak_value_cents": {
        "type": "integer",
        "minimum": 0,
        "description": "Peak portfolio value in cents"
      },
      "current_drawdown_pct": {
        "type": "number",
        "minimum": 0,
        "maximum": 100,
        "multipleOf": 0.001,
        "description": "Current drawdown percentage from peak"
      },
      "max_drawdown_pct": {
        "type": "number",
        "minimum": 0,
        "maximum": 100,
        "multipleOf": 0.001,
        "description": "Maximum historical drawdown percentage"
      },
      "created_at": {
        "$ref": "#/definitions/timestamp"
      },
      "allocations": {
        "type": "array",
        "items": {
          "$ref": "#/PortfolioAllocation"
        },
        "description": "Detailed asset allocations for this snapshot"
      }
    },
    "additionalProperties": false
  },

  "PortfolioAllocation": {
    "type": "object",
    "title": "Portfolio Asset Allocation",
    "description": "Individual asset allocation within a portfolio snapshot",
    "required": [
      "portfolio_snapshot_id",
      "asset_id",
      "position_value_cents",
      "weight_pct",
      "quantity",
      "average_cost_cents",
      "current_price_cents"
    ],
    "properties": {
      "id": {
        "$ref": "#/definitions/uuid"
      },
      "portfolio_snapshot_id": {
        "$ref": "#/definitions/uuid",
        "description": "Parent portfolio snapshot"
      },
      "asset_id": {
        "$ref": "#/definitions/uuid",
        "description": "Asset identifier"
      },
      "asset_class_id": {
        "type": "integer",
        "minimum": 1,
        "description": "Asset class identifier"
      },
      "position_value_cents": {
        "type": "integer",
        "minimum": 0,
        "description": "Position value in cents"
      },
      "weight_pct": {
        "$ref": "#/definitions/percentage",
        "description": "Weight as percentage of total portfolio"
      },
      "quantity": {
        "type": "integer",
        "not": {
          "const": 0
        },
        "description": "Position quantity"
      },
      "average_cost_cents": {
        "$ref": "#/definitions/cents",
        "description": "Average cost in cents per share"
      },
      "current_price_cents": {
        "$ref": "#/definitions/cents",
        "description": "Current price in cents per share"
      },
      "unrealized_pnl_cents": {
        "$ref": "#/definitions/signed_cents",
        "description": "Unrealized P&L for this position in cents"
      },
      "unrealized_pnl_pct": {
        "$ref": "#/definitions/signed_percentage",
        "description": "Unrealized P&L percentage for this position"
      },
      "created_at": {
        "$ref": "#/definitions/timestamp"
      }
    },
    "additionalProperties": false
  },

  "UserSignalInteraction": {
    "type": "object",
    "title": "User Signal Interaction",
    "description": "Track user interactions with trading signals",
    "required": [
      "signal_match_id",
      "user_id",
      "signal_id",
      "interaction_type"
    ],
    "properties": {
      "id": {
        "$ref": "#/definitions/uuid"
      },
      "signal_match_id": {
        "$ref": "#/definitions/uuid",
        "description": "Signal match that generated this interaction"
      },
      "user_id": {
        "$ref": "#/definitions/uuid",
        "description": "User performing the interaction"
      },
      "signal_id": {
        "$ref": "#/definitions/uuid",
        "description": "Signal being interacted with"
      },
      "interaction_type": {
        "type": "string",
        "maxLength": 50,
        "enum": ["view", "favorite", "share", "dismiss", "execute", "modify"],
        "description": "Type of interaction"
      },
      "interaction_timestamp": {
        "$ref": "#/definitions/timestamp",
        "description": "When interaction occurred"
      },
      "interaction_source": {
        "type": "string",
        "maxLength": 50,
        "enum": ["web_app", "mobile_app", "email", "api"],
        "description": "Source of the interaction"
      },
      "session_id": {
        "type": "string",
        "maxLength": 100,
        "description": "User session identifier"
      },
      "modified_position_size_pct": {
        "$ref": "#/definitions/percentage",
        "description": "User-modified position size percentage"
      },
      "modified_stop_loss_cents": {
        "$ref": "#/definitions/cents",
        "description": "User-modified stop loss price in cents"
      },
      "modified_target_price_cents": {
        "$ref": "#/definitions/cents",
        "description": "User-modified target price in cents"
      },
      "modification_reason": {
        "type": "string",
        "description": "Reason for user modifications"
      },
      "device_type": {
        "type": "string",
        "maxLength": 20,
        "enum": ["desktop", "mobile", "tablet"],
        "description": "Device type used for interaction"
      },
      "user_agent": {
        "type": "string",
        "description": "Browser user agent string"
      },
      "ip_address": {
        "type": "string",
        "format": "ipv4",
        "description": "User's IP address"
      },
      "created_at": {
        "$ref": "#/definitions/timestamp"
      }
    },
    "additionalProperties": false
  }
}